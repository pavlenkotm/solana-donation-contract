name: Release and Deploy

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'devnet'
        type: choice
        options:
          - devnet
          - mainnet-beta

env:
  CARGO_TERM_COLOR: always
  SOLANA_VERSION: 1.18.0
  ANCHOR_VERSION: 0.30.1

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body: |
            ## What's Changed

            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.

            ## Deployment

            ### Program ID
            Check the deployment details in the assets below.

            ### Verification
            ```bash
            solana program show <PROGRAM_ID>
            ```

            ## Security

            See [SECURITY.md](https://github.com/${{ github.repository }}/blob/main/SECURITY.md) for security considerations.
          draft: false
          prerelease: false

  build-release:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - name: Install Solana
        run: |
          sh -c "$(curl -sSfL https://release.solana.com/v${{ env.SOLANA_VERSION }}/install)"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH

      - name: Install Anchor
        run: |
          cargo install --git https://github.com/coral-xyz/anchor --tag v${{ env.ANCHOR_VERSION }} anchor-cli --locked --force

      - name: Build program (release mode)
        run: anchor build --verifiable

      - name: Generate checksums
        run: |
          cd target/deploy
          sha256sum *.so > checksums.txt
          cat checksums.txt

      - name: Create deployment info
        run: |
          echo "Build Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" > deployment-info.txt
          echo "Commit: ${{ github.sha }}" >> deployment-info.txt
          echo "Tag: ${{ github.ref_name }}" >> deployment-info.txt
          echo "Anchor Version: ${{ env.ANCHOR_VERSION }}" >> deployment-info.txt
          echo "Solana Version: ${{ env.SOLANA_VERSION }}" >> deployment-info.txt

      - name: Upload release artifacts
        uses: actions/upload-artifact@v3
        with:
          name: release-build
          path: |
            target/deploy/*.so
            target/deploy/checksums.txt
            target/idl/*.json
            deployment-info.txt
          retention-days: 90

      - name: Upload to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            target/deploy/*.so
            target/deploy/checksums.txt
            target/idl/*.json
            deployment-info.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-devnet:
    name: Deploy to Devnet
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'devnet') ||
      (startsWith(github.ref, 'refs/tags/') && contains(github.ref, 'beta'))
    needs: build-release
    environment:
      name: devnet
      url: https://explorer.solana.com/?cluster=devnet
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Solana
        run: |
          sh -c "$(curl -sSfL https://release.solana.com/v${{ env.SOLANA_VERSION }}/install)"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH

      - name: Configure Solana for Devnet
        run: |
          solana config set --url devnet
          solana config get

      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          name: release-build
          path: ./deploy

      - name: Display deployment info
        run: |
          echo "Deploying to Devnet..."
          cat ./deploy/deployment-info.txt
          cat ./deploy/checksums.txt

      # Note: Actual deployment requires private key
      # This is a placeholder - configure with your deployment strategy
      - name: Deploy Program (Placeholder)
        run: |
          echo "⚠️  Deployment requires configuration of SOLANA_DEPLOYER_KEY secret"
          echo "Program ready for deployment:"
          ls -lh ./deploy/*.so

  notify:
    name: Notify on Completion
    runs-on: ubuntu-latest
    needs: [build-release]
    if: always()
    steps:
      - name: Check status
        run: |
          if [ "${{ needs.build-release.result }}" == "success" ]; then
            echo "✅ Release build completed successfully"
          else
            echo "❌ Release build failed"
            exit 1
          fi
